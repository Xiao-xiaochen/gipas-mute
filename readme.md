# koishi-plugin-gipas-mute

[![npm](https://img.shields.io/npm/v/koishi-plugin-gipas-mute?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-gipas-mute)

基于 Koishi 框架的 QQ 群定时禁言管理插件。采用**三层配置架构**，支持**法定节假日识别**，即使意外重启也能自动纠正禁言状态。

GIPAS(Group Information Procesing Automatic System)

GIPAS官方Q群群号: 1071284605

## ✨ 核心功能

- 🎯 **三层配置架构** - 禁言时间表 → 星期调度 → 群组绑定
- 💾 **状态维持机制** - 每分钟心跳检测，确保状态始终一致
- 🇨🇳 **法定节假日支持** - 自动识别调休工作日和节假日
- 🔄 **混合模式** - 在线 API + 本地缓存 + 离线包三种方案
- 🎨 **图形化配置** - Koishi 管理面板即点即配

## 工作原理

### 三层配置

| 层级 | 用途 | 示例 |
|------|------|------|
| **禁言组** (MuteGroup) | 定义禁言时间和状态 | 工作日禁言、休息日禁言 |
| **星期组** (WeekGroup) | 定义周日程和禁言组映射 | 周一~五用工作日禁言，周六日用休息日禁言 |
| **群组配置** (GroupConfig) | 绑定 QQ 群和调度策略 | 群 123456789 使用标准配置 |

### 禁言规则计算

每分钟自动执行以下流程：

1. **判断日期类型**
   - 是调休工作日？→ 使用调休禁言组
   - 是节假日？→ 使用节假日禁言组
   - 普通日期？→ 按星期组规则

2. **计算当前应该的禁言状态**
   - 在禁言组的时间规则中找到 **≤ 当前时间的最后一条规则**
   - 若今天无匹配规则，**自动回溯到前一天**
   - 获得期望状态

3. **对齐状态**
   - 比对数据库中的实际状态
   - 状态不一致？调用 OneBot API 更新
   - 发送通知消息

**示例**：凌晨 02:00，最早规则是今天 09:00 禁言
- 自动回溯到昨天
- 获取昨天最后规则（如 18:00 解禁）
- 确保群保持解禁状态
- 即使机器人刚启动也能推断正确状态

## 节假日判断

支持三种模式（可在配置中选择）：

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| **离线** | 使用 npm 包 `chinese-days` | 不依赖网络，需预装依赖 |
| **在线** | 调用公开 API `holiday.cyi.me` | 实时准确，需网络连接 |
| **混合** | 优先在线，缓存 24h，失败回退离线 | **推荐**，性能和可靠性最佳 |

## 配置示例

所有配置均在 Koishi 管理面板中进行，无需手动编辑 YAML。

**默认提供的示例配置**：
- 禁言组：工作日禁言、休息日禁言
- 星期组：默认星期组（工作日用工作日禁言，周末用休息日禁言）
- 群组配置：示例群号 978515338

直接在管理面板中编辑即可上手使用！

## 依赖

### 必需
- `koishi >= 4.18.7`

### 可选
- `chinese-days` - 离线节假日计算
  ```bash
  npm install chinese-days
  ```
  若不安装，自动降级到在线或混合模式

## 使用场景

### 场景 1：多群差异化配置
- 创建不同的禁言组（严格、宽松等）
- 为不同的群关联不同的禁言组和星期组
- 调休日和节假日各自设置

### 场景 2：智能应对法定假期
- 启用节假日判断
- 为调休日设置工作日禁言
- 为节假日设置假期禁言
- 自动在工作日/假期间切换

### 场景 3：特殊日期规则
- 创建一个只在特定日期使用的禁言组
- 通过修改配置临时调整

## 故障排查

**禁言状态未生效**
- 检查群号是否正确
- 验证禁言组/星期组名称是否存在
- 确保 Bot 具有群管理权限
- 查看日志中的警告信息

**节假日识别不准确**
- 安装 `chinese-days` 包，切换到离线模式
- 或使用在线模式确保实时准确

## 许可证

MIT

